# Secure Data Export System

## Overview

The export system enables controlled data downloads while preventing data hoarding and encouraging platform subscriptions. Every export includes anti-churn mechanisms and freshness indicators.

## Export Types

### 1. Snapshot Export (One-time, Pay-per-report)

**Characteristics:**
- Frozen forever - no updates
- Max 1 export per industry + city combination
- Perfect for one-time analysis
- Expires after 7 days

**Use Case:** Client needs data for a specific project

### 2. Subscription Export (Monthly, Limited)

**Characteristics:**
- Monthly row limits (plan-based)
- Monthly export count limits
- Fresh data from platform
- Expires after 30 days

**Use Case:** Regular monthly data updates for subscribers

### 3. Admin Export (Internal, Unlimited)

**Characteristics:**
- No limits
- For internal use only
- Full dataset access

**Use Case:** Internal reporting, analytics

## Anti-Churn Mechanisms

### Mandatory Features

1. **Last Verified At Column**
   - Shows when contact was last verified
   - Highlights data freshness decay
   - Encourages re-export for fresh data

2. **Footer Watermark**
   ```
   Generated by Business Intelligence Pro
   Snapshot date: YYYY-MM-DD
   Data may be outdated.
   ```

3. **Excel Metadata Watermark**
   - Embedded in file properties
   - Visible in file info
   - Cannot be easily removed

4. **Export Timestamp**
   - Stored in database
   - Tracks all exports
   - Prevents abuse

## Plan Limits

| Plan | Snapshot Exports | Subscription Exports/Month | Rows/Month |
|------|-----------------|---------------------------|------------|
| Free | 0 | 0 | 0 |
| Basic | 1 per industry+city | 1 | 1,000 |
| Professional | 1 per industry+city | 3 | 5,000 |
| Enterprise | 1 per industry+city | 10 | 50,000 |
| Admin | Unlimited | Unlimited | Unlimited |

## Export Content

### Mandatory Fields

Every export includes:

- `company_name` - Business name
- `industry` - Industry name
- `city` - City name
- `address` - Business address
- `website` - Website URL
- `email` - Contact email
- `phone` - Contact phone
- `mobile` - Contact mobile
- `source_url` - Exact source page
- `first_seen_at` - When contact was first discovered
- `last_verified_at` - When contact was last verified
- `contact_status` - active | removed

## Usage

### CLI

```bash
# Snapshot export
npm run export snapshot user123 xlsx 1 5
# Type: snapshot, User: user123, Format: xlsx, Industry: 1, City: 5

# Subscription export
npm run export subscription user123 xlsx "" "" 1000
# Type: subscription, User: user123, Format: xlsx, Row limit: 1000

# Admin export
npm run export admin admin123 xlsx "" "" 10000
```

### Programmatic

```typescript
import { executeExportJob } from './jobs/exportJob.js';

// Snapshot export
const result = await executeExportJob({
  userId: 'user123',
  exportType: 'snapshot',
  format: 'xlsx',
  industryId: 1,
  cityId: 5
});

// Subscription export
const result = await executeExportJob({
  userId: 'user123',
  exportType: 'subscription',
  format: 'xlsx',
  filters: {
    industryId: 1,
    isActiveContactsOnly: true,
    minLastVerifiedDays: 30
  },
  rowLimit: 1000
});
```

## File Storage

### Supabase Storage

Files are stored in:
```
/exports/{user_id}/{export_id}.xlsx
```

### Security

- ✅ No public URLs
- ✅ Signed URLs only (time-limited)
- ✅ User-specific folders
- ✅ Access control via Supabase RLS

### URL Expiration

- **Snapshot**: 7 days
- **Subscription**: 30 days
- **Admin**: 30 days

## Export Pipeline

```
1. User requests export
   ↓
2. Validate plan limits
   ↓
3. Query filtered dataset
   ↓
4. Apply row cap
   ↓
5. Generate file (Excel/CSV)
   ↓
6. Embed watermark
   ↓
7. Upload to Supabase Storage
   ↓
8. Log export record
   ↓
9. Return signed download URL
```

## Database Schema

### `exports` Table

```sql
CREATE TABLE exports (
  id UUID PRIMARY KEY,
  user_id VARCHAR(255) NOT NULL,
  export_type VARCHAR(20) NOT NULL,
  industry_id INTEGER,
  city_id INTEGER,
  total_rows INTEGER NOT NULL,
  file_format VARCHAR(10) NOT NULL,
  file_path TEXT NOT NULL,
  watermark_text TEXT NOT NULL,
  filters JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ
);
```

## Migration

Run migration to create exports table:

```bash
npm run migrate:exports
```

Or manually:

```bash
npm run migrate create_exports_table.sql
```

## Environment Variables

Add to `.env`:

```bash
# Supabase Storage
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_KEY=your-service-key
```

## Security Features

- ✅ Plan limit enforcement
- ✅ Row limit enforcement
- ✅ Export logging
- ✅ Signed URLs only
- ✅ No direct database dumps
- ✅ No raw HTML exports
- ✅ Watermarking mandatory
- ✅ Freshness indicators

## Watermarking

### Excel Files

- Footer row with watermark text
- File metadata properties
- Creator field
- Created/modified timestamps

### CSV Files

- Footer lines with watermark
- Visible in file content
- Cannot be easily removed

## Best Practices

1. **Always include watermarks** - Never skip anti-churn mechanisms
2. **Enforce limits strictly** - Reject excess exports
3. **Log everything** - Track all export activity
4. **Use signed URLs** - Never expose public URLs
5. **Highlight freshness** - Make data decay obvious
6. **Monitor usage** - Track export patterns

## Monitoring

### Export Logs

Query export activity:

```sql
-- User export history
SELECT * FROM exports
WHERE user_id = 'user123'
ORDER BY created_at DESC;

-- Monthly export usage
SELECT 
  user_id,
  export_type,
  COUNT(*) as export_count,
  SUM(total_rows) as total_rows
FROM exports
WHERE created_at >= date_trunc('month', CURRENT_DATE)
GROUP BY user_id, export_type;
```

## Error Handling

The system handles:

- Plan limit exceeded
- Row limit exceeded
- Storage upload failures
- Invalid filters
- Missing data

All errors are logged and returned to the user with clear messages.

## Future Enhancements

- [ ] Export scheduling
- [ ] Email delivery
- [ ] Export templates
- [ ] Custom field selection
- [ ] Export analytics dashboard
- [ ] Automatic cleanup of expired files
